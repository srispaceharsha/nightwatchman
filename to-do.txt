Excellent integration plan! Here's my comprehensive analysis and task breakdown:

  üìã Necessary Tasks for Raspberry Pi + Home Assistant Integration

  Phase 1: Raspberry Pi Setup üçì

  1.1 Hardware Setup
  - Connect NoIR camera to Raspberry Pi 5's CSI port
  - Verify camera detection: libcamera-hello --list-cameras
  - Test camera: libcamera-still -o test.jpg

  1.2 System Dependencies
  - Update system: sudo apt update && sudo apt upgrade
  - Install Python 3.11+: sudo apt install python3.11 python3.11-venv
  - Install camera libraries: sudo apt install python3-picamera2
  - Install system packages for OpenCV: sudo apt install libopencv-dev python3-opencv

  1.3 Application Setup
  - Copy nightwatchman project to Pi: ~/nightwatchman/
  - Create virtual environment: python3.11 -m venv .venv
  - Install dependencies: pip install -r requirements.txt
  - Configure for Pi Camera (modify camera initialization)

  Phase 2: Camera Adapter Code üì∑

  2.1 NoIR Camera Support
  - Create camera_pi.py wrapper for Picamera2/libcamera
  - Modify main.py to detect Pi camera vs USB webcam
  - Test with NoIR camera (works in low light/IR)
  - Adjust camera settings for nighttime monitoring

  2.2 Configuration Updates
  camera:
    type: picamera  # or 'usb' for webcam
    device_id: 0
    resolution_width: 640
    resolution_height: 480
    processing_fps: 5  # Already optimized for Pi!

  Phase 3: Home Assistant Integration üè†

  3.1 Webhook Sender Module
  - Create home_assistant.py with webhook client
  - Implement send_alert(event_type, data) function
  - Add retry logic for network failures
  - Store HA webhook URL in config

  3.2 Home Assistant Configuration
  - Create webhook automation in HA:
  # configuration.yaml or automations.yaml
  automation:
    - alias: "Nightwatchman Alert"
      trigger:
        platform: webhook
        webhook_id: nightwatchman_alert
      action:
        service: notify.mobile_app_<your_iphone>
        data:
          title: "üö® Patient Alert"
          message: "{{ trigger.json.message }}"
          data:
            push:
              sound: "US-EN-Alexa-Motion-Detected-Generic.wav"
              interruption-level: "critical"

  3.3 Integration Points
  - Send alert when: Person sits up (ALERT_ACTIVE)
  - Send notification when: Alert dismissed
  - Send status updates: Monitoring started/paused/resumed
  - Include: Timestamp, confidence, patient state

  Phase 4: Code Modifications üíª

  4.1 Add Home Assistant Module
  # home_assistant.py
  import requests
  import json

  class HomeAssistantNotifier:
      def __init__(self, webhook_url):
          self.webhook_url = webhook_url

      def send_alert(self, alert_type, message, data=None):
          payload = {
              "alert_type": alert_type,
              "message": message,
              "timestamp": time.time(),
              "data": data or {}
          }
          try:
              response = requests.post(
                  self.webhook_url,
                  json=payload,
                  timeout=5
              )
              return response.status_code == 200
          except Exception as e:
              print(f"HA notification failed: {e}")
              return False

  4.2 Modify main.py
  - Import HomeAssistantNotifier
  - Initialize in __init__()
  - Call send_alert() in _handle_transition() when ALERT_ACTIVE
  - Send status updates for system state changes

  4.3 Update config.yaml
  home_assistant:
    enabled: true
    webhook_url: "http://192.168.1.4:8123/api/webhook/nightwatchman_alert"
    send_on_alert: true
    send_on_dismiss: true
    send_status_updates: true

  Phase 5: Deployment & Autostart üöÄ

  5.1 Systemd Service
  - Create /etc/systemd/system/nightwatchman.service:
  [Unit]
  Description=Nightwatchman Senior Care Monitor
  After=network.target

  [Service]
  Type=simple
  User=pi
  WorkingDirectory=/home/pi/nightwatchman
  ExecStart=/home/pi/nightwatchman/.venv/bin/python main.py
  Restart=always
  RestartSec=10

  [Install]
  WantedBy=multi-user.target

  5.2 Enable Auto-start
  - sudo systemctl daemon-reload
  - sudo systemctl enable nightwatchman
  - sudo systemctl start nightwatchman
  - sudo systemctl status nightwatchman

  5.3 Logging
  - Configure logging to file: /var/log/nightwatchman/
  - Set up log rotation: /etc/logrotate.d/nightwatchman
  - Monitor logs: journalctl -u nightwatchman -f

  Phase 6: Testing & Validation ‚úÖ

  6.1 Component Tests
  - Test NoIR camera in dark environment
  - Test gesture detection (thumbs up/down)
  - Test posture detection (lying/sitting)
  - Test webhook to Home Assistant
  - Test iPhone notification delivery

  6.2 Integration Tests
  - Full workflow: Sit up ‚Üí Alert ‚Üí iPhone notification
  - Test notification sound/vibration
  - Test critical alert priority (bypasses silent mode)
  - Test in actual nighttime conditions

  6.3 Performance Tests
  - CPU usage at 5 FPS (should be <30%)
  - Memory usage (should be <1GB)
  - Network latency to HA webhook
  - System stability over 24 hours

  Phase 7: Optimization for NoIR Camera üåô

  7.1 Night Vision Considerations
  - NoIR camera sees infrared - add IR illuminator if needed
  - Adjust MediaPipe confidence thresholds for IR image quality
  - Test detection accuracy in complete darkness
  - May need to lower min_detection_confidence to 0.3

  7.2 Camera Settings
  # For Picamera2
  picam2.set_controls({
      "ExposureTime": 10000,  # Longer exposure for low light
      "AnalogueGain": 2.0,     # Boost gain
      "Brightness": 0.1        # Slight brightness boost
  })

  üì¶ Additional Files Needed

  1. home_assistant.py - Webhook notifier class
  2. camera_pi.py - Pi camera wrapper
  3. systemd/nightwatchman.service - Auto-start service
  4. install_pi.sh - Installation script for dependencies
  5. requirements_pi.txt - Pi-specific dependencies

  üîß Updated Dependencies

  Add to requirements.txt:
  picamera2>=0.3.12
  requests>=2.31.0

  ‚ö†Ô∏è Potential Issues & Solutions

  | Issue                     | Solution                                 |
  |---------------------------|------------------------------------------|
  | NoIR camera not detected  | Enable camera in raspi-config            |
  | Low light detection fails | Add IR LED illuminator                   |
  | Webhook timeouts          | Add retry logic with exponential backoff |
  | Pi overheating            | Add heatsink, ensure ventilation         |
  | Network unreliable        | Queue alerts locally, retry on reconnect |
  | MediaPipe slow on Pi      | Already optimized at 5 FPS! ‚úì            |

  üéØ Estimated Timeline

  - Phase 1-2: 2-3 hours (Pi setup + camera)
  - Phase 3-4: 3-4 hours (HA integration + code)
  - Phase 5: 1-2 hours (deployment)
  - Phase 6-7: 2-3 hours (testing + optimization)

  Total: ~8-12 hours for complete deployment

  üì± Home Assistant Notification Example

  When alert triggers, your iPhone will receive:
  üö® Patient Alert
  Person sitting up detected
  Confidence: 89%
  Time: 2:34 AM
  Posture: SITTING (angle: 95¬∞)

  With critical alert sound that bypasses silent mode!

  ---
  Would you like me to start implementing any of these phases? I can create the Home Assistant integration module, Pi camera
  wrapper, or the systemd service file first!